<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Neartail Annual Cost Calculator (£) - Improved</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 28px;
      background: #f5f7fb;
      color: #222;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(25,40,60,0.06);
    }
    h1 { margin: 0 0 12px 0; font-size: 22px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input[type="number"], input[type="range"] {
      width:100%; margin-top:8px; padding:8px; box-sizing:border-box;
      border-radius:6px; border:1px solid #d6d9de;
    }
    input[type="number"]:invalid {
      border-color: #e74c3c;
      background-color: #fdf2f2;
    }
    .error-message {
      color: #e74c3c;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }
    .constants, .results, .chart-area {
      margin-top:18px; padding:14px; border-radius:10px;
      background:#fbfcff; border:1px solid #e6e9ef;
    }
    .row { display:flex; justify-content:space-between; align-items:center; margin:8px 0; }
    .label { color:#444; }
    .value { font-weight:700; color:#0b61a4; }
    hr { border:none; border-top:1px solid #e6e9ef; margin:14px 0; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid #eef2f6; }
    th { background:#f3f6fb; font-weight:700; color:#333; }
    canvas { width:100% !important; max-width:100%; height:320px; }
    .note { font-size:13px; color:#555; margin-top:8px; }
    .validation-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Neartail Annual Cost Calculator (£) - Improved Version</h1>

    <div id="validationWarning" class="validation-warning">
      <strong>⚠️ Input Validation Issues:</strong>
      <ul id="validationList"></ul>
    </div>

    <!-- Inputs -->
    <label for="attendanceSmall">Regular event attendance (4 events)</label>
    <input id="attendanceSmall" type="number" min="0" step="1" value="35" />
    <div class="error-message" id="errorSmall">Attendance must be a positive whole number</div>

    <label for="attendanceLarge">Large event attendance (1 event)</label>
    <input id="attendanceLarge" type="number" min="0" step="1" value="130" />
    <div class="error-message" id="errorLarge">Attendance must be a positive whole number</div>

    <label for="ticketPrice">Ticket price (£)</label>
    <input id="ticketPrice" type="number" min="0" step="0.01" value="40" />
    <div class="error-message" id="errorPrice">Ticket price must be positive</div>

    <label for="cardPercent">Card payments (% of tickets): <span id="cardLabel">25</span>%</label>
    <input id="cardPercent" type="range" min="0" max="100" step="1" value="25" />

    <label for="monthlyPremiumCost">Neartail Monthly Package Cost (£)</label>
    <input id="monthlyPremiumCost" type="number" min="0" step="0.01" value="28.00" />
    <div class="error-message" id="errorMonthly">Monthly cost must be positive</div>

    <label for="memberCount">Number of organisation members</label>
    <input id="memberCount" type="number" min="1" step="1" value="44" />
    <div class="error-message" id="errorMembers">Member count must be at least 1</div>

    <!-- Constants -->
    <div class="constants">
      <div class="row"><div class="label">Total events per year</div><div class="value">5 (4 regular + 1 large)</div></div>
      <div class="row"><div class="label">Ticket price</div><div class="value" id="ticketPriceDisplay">£40.00</div></div>
      <div class="row"><div class="label">Neartail Monthly Package</div><div class="value" id="monthlyDisplay">£28.00</div></div>
      <div class="row"><div class="label">Neartail Annual Package</div><div class="value" id="annualDisplay">£336.00</div></div>
      <div class="row"><div class="label">Transaction fee</div><div class="value">1.5% + £0.20 per card transaction</div></div>
    </div>

    <!-- Results -->
    <div class="results" aria-live="polite">
      <div style="font-weight:700; margin-bottom:8px;">Annual overview</div>
      <div class="row"><div class="label">Total tickets per year</div><div class="value" id="totalTickets">270</div></div>
      <div class="row"><div class="label">Card tickets</div><div class="value" id="cardTickets">68</div></div>
      <div class="row"><div class="label">Transaction fees</div><div class="value" id="transactionFees">£54.40</div></div>
      <div class="row"><div class="label">Total annual cost</div><div class="value" id="totalCost">£390.40</div></div>
      <div class="row"><div class="label">Cost as % of ticket revenue</div><div class="value" id="costPercent">3.40%</div></div>
      <div class="row"><div class="label">Average cost per event</div><div class="value" id="costPerEvent">£78.08</div></div>
      <div class="row"><div class="label">Annual cost per member</div><div class="value" id="annualPerMember">£8.87</div></div>
      <div class="row"><div class="label">Cost per event per member</div><div class="value" id="costPerMember">£1.77</div></div>

      <hr/>

      <div style="font-weight:700; margin-bottom:8px;">Per Event Breakdown</div>
      <table>
        <thead>
          <tr><th>Metric</th><th>Regular Event (4×)</th><th>Large Event (1×)</th></tr>
        </thead>
        <tbody>
          <tr><td>Attendance</td><td id="attSmallCell">35</td><td id="attLargeCell">130</td></tr>
          <tr><td>Card sales (tickets)</td><td id="cardSmall">9</td><td id="cardLarge">33</td></tr>
          <tr><td>Card revenue (£)</td><td id="revSmall">£360.00</td><td id="revLarge">£1,320.00</td></tr>
          <tr><td>Transaction fees (£)</td><td id="feesSmall">£7.44</td><td id="feesLarge">£26.32</td></tr>
          <tr><td>Total cost per event (subscription + fees)</td><td id="totalSmall">£78.08</td><td id="totalLarge">£78.08</td></tr>
          <tr><td>Cost % of ticket revenue</td><td id="pctSmall">5.42%</td><td id="pctLarge">1.98%</td></tr>
          <tr><td>Cost per member (per event)</td><td id="perMemberSmall">£1.77</td><td id="perMemberLarge">£1.77</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Comparison Chart -->
    <div class="chart-area">
      <h3>Example Comparison Scenarios</h3>
      <canvas id="comparisonChart"></canvas>
      <p class="note">Illustrates how plan choice and membership size affect per-member annual cost.</p>
    </div>

    <!-- Dynamic Chart -->
    <div class="chart-area">
      <h3>Dynamic Cost per Member vs Membership Size</h3>
      <canvas id="dynamicChart"></canvas>
      <p class="note">Shows the live relationship between total members and per-member annual cost.</p>
    </div>
  </div>

  <script>
    // Input elements
    const attendanceSmallInput = document.getElementById('attendanceSmall');
    const attendanceLargeInput = document.getElementById('attendanceLarge');
    const ticketPriceInput = document.getElementById('ticketPrice');
    const cardPercentInput = document.getElementById('cardPercent');
    const cardLabel = document.getElementById('cardLabel');
    const monthlyPremiumCostInput = document.getElementById('monthlyPremiumCost');
    const memberCountInput = document.getElementById('memberCount');

    // Display elements
    const ticketPriceDisplay = document.getElementById('ticketPriceDisplay');
    const monthlyDisplayEl = document.getElementById('monthlyDisplay');
    const annualDisplayEl = document.getElementById('annualDisplay');

    // Result elements
    const totalTicketsEl = document.getElementById('totalTickets');
    const cardTicketsEl = document.getElementById('cardTickets');
    const transactionFeesEl = document.getElementById('transactionFees');
    const totalCostEl = document.getElementById('totalCost');
    const costPercentEl = document.getElementById('costPercent');
    const costPerEventEl = document.getElementById('costPerEvent');
    const annualPerMemberEl = document.getElementById('annualPerMember');
    const costPerMemberEl = document.getElementById('costPerMember');

    // Table elements
    const attSmallCell = document.getElementById('attSmallCell');
    const attLargeCell = document.getElementById('attLargeCell');
    const cardSmall = document.getElementById('cardSmall');
    const cardLarge = document.getElementById('cardLarge');
    const revSmall = document.getElementById('revSmall');
    const revLarge = document.getElementById('revLarge');
    const feesSmall = document.getElementById('feesSmall');
    const feesLarge = document.getElementById('feesLarge');
    const totalSmall = document.getElementById('totalSmall');
    const totalLarge = document.getElementById('totalLarge');
    const pctSmall = document.getElementById('pctSmall');
    const pctLarge = document.getElementById('pctLarge');
    const perMemberSmall = document.getElementById('perMemberSmall');
    const perMemberLarge = document.getElementById('perMemberLarge');

    // Validation elements
    const validationWarning = document.getElementById('validationWarning');
    const validationList = document.getElementById('validationList');

    // Constants
    const FEE_RATE = 0.015;
    const FEE_FIXED = 0.20;
    const TOTAL_EVENTS = 5;

    // Utility functions
    function isValidPositiveNumber(value) {
      return !isNaN(value) && isFinite(value) && value >= 0;
    }

    function isValidPositiveInteger(value) {
      return Number.isInteger(value) && value >= 0;
    }

    function safeRound(number, decimals = 2) {
      return Math.round((number + Number.EPSILON) * Math.pow(10, decimals)) / Math.pow(10, decimals);
    }

    function safeDivide(numerator, denominator, fallback = 0) {
      return denominator === 0 ? fallback : numerator / denominator;
    }

    function formatCurrency(amount) {
      return `£${safeRound(amount, 2).toFixed(2)}`;
    }

    function formatPercentage(value) {
      return `${safeRound(value, 2).toFixed(2)}%`;
    }

    // Validation function
    function validateInputs() {
      const validationErrors = [];
      
      const attSmall = Number(attendanceSmallInput.value);
      const attLarge = Number(attendanceLargeInput.value);
      const ticketPrice = Number(ticketPriceInput.value);
      const monthlyPremium = Number(monthlyPremiumCostInput.value);
      const members = Number(memberCountInput.value);

      // Validate attendance
      if (!isValidPositiveInteger(attSmall)) {
        validationErrors.push('Regular event attendance must be a whole number ≥ 0');
        document.getElementById('errorSmall').style.display = 'block';
      } else {
        document.getElementById('errorSmall').style.display = 'none';
      }

      if (!isValidPositiveInteger(attLarge)) {
        validationErrors.push('Large event attendance must be a whole number ≥ 0');
        document.getElementById('errorLarge').style.display = 'block';
      } else {
        document.getElementById('errorLarge').style.display = 'none';
      }

      // Validate prices
      if (!isValidPositiveNumber(ticketPrice)) {
        validationErrors.push('Ticket price must be ≥ £0');
        document.getElementById('errorPrice').style.display = 'block';
      } else {
        document.getElementById('errorPrice').style.display = 'none';
      }

      if (!isValidPositiveNumber(monthlyPremium)) {
        validationErrors.push('Monthly premium must be ≥ £0');
        document.getElementById('errorMonthly').style.display = 'block';
      } else {
        document.getElementById('errorMonthly').style.display = 'none';
      }

      // Validate members
      if (!Number.isInteger(members) || members < 1) {
        validationErrors.push('Member count must be at least 1');
        document.getElementById('errorMembers').style.display = 'block';
      } else {
        document.getElementById('errorMembers').style.display = 'none';
      }

      // Validate realistic limits
      if (attSmall > 10000) validationErrors.push('Regular event attendance seems unusually high (>10,000)');
      if (attLarge > 50000) validationErrors.push('Large event attendance seems unusually high (>50,000)');
      if (ticketPrice > 1000) validationErrors.push('Ticket price seems unusually high (>£1,000)');
      if (members > 100000) validationErrors.push('Member count seems unusually high (>100,000)');

      // Update validation display
      if (validationErrors.length > 0) {
        validationList.innerHTML = validationErrors.map(err => `<li>${err}</li>`).join('');
        validationWarning.style.display = 'block';
        return false;
      } else {
        validationWarning.style.display = 'none';
        return true;
      }
    }

    // Chart initialization
    const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
    const dynamicCtx = document.getElementById('dynamicChart').getContext('2d');

    const comparisonChart = new Chart(comparisonCtx, {
      type: 'bar',
      data: {
        labels: ['Current (Premium, 44)', 'Basic Plan (44)', 'Premium + 60 members', 'Basic + 60 members'],
        datasets: [{
          label: 'Annual Cost per Member (£)',
          data: [9.25, 6.52, 6.78, 4.78],
          backgroundColor: ['#0b61a4','#1e90ff','#28a745','#6cc24a']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { 
            callbacks: { 
              label: ctx => `£${ctx.parsed.y.toFixed(2)} / member` 
            }
          }
        },
        scales: { 
          y: { 
            beginAtZero: true, 
            title: { display: true, text: '£ / member' } 
          } 
        }
      }
    });

    const dynamicChart = new Chart(dynamicCtx, {
      type: 'line',
      data: { 
        labels: [], 
        datasets: [{
          label: 'Cost per Member (£)',
          data: [], 
          borderColor: '#0b61a4', 
          borderWidth: 2, 
          fill: false, 
          tension: 0.2, 
          pointBackgroundColor: '#0b61a4'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { 
          y: { beginAtZero: true, title: { display: true, text: '£ / member' } }, 
          x: { title: { display: true, text: 'Number of Members' } } 
        }
      }
    });

    // Main calculation function
    function recalc() {
      // Validate inputs first
      if (!validateInputs()) {
        return; // Don't update if validation fails
      }

      const attSmall = Number(attendanceSmallInput.value);
      const attLarge = Number(attendanceLargeInput.value);
      const ticketPrice = Number(ticketPriceInput.value);
      const cardPct = Number(cardPercentInput.value);
      const monthlyPremium = Number(monthlyPremiumCostInput.value);
      const members = Number(memberCountInput.value);

      const annualPremium = monthlyPremium * 12;

      // Update display values
      cardLabel.textContent = cardPct;
      ticketPriceDisplay.textContent = formatCurrency(ticketPrice);
      monthlyDisplayEl.textContent = formatCurrency(monthlyPremium);
      annualDisplayEl.textContent = formatCurrency(annualPremium);

      // Calculate core metrics
      const totalTickets = attSmall * 4 + attLarge;
      const totalCardTickets = safeRound(totalTickets * (cardPct / 100), 0);

      const feePerCard = safeRound((ticketPrice * FEE_RATE) + FEE_FIXED, 2);
      const totalFees = safeRound(totalCardTickets * feePerCard, 2);
      const totalCost = safeRound(annualPremium + totalFees, 2);

      const totalRevenue = totalTickets * ticketPrice;
      const costPercent = safeDivide(totalCost * 100, totalRevenue, 0);
      const costPerEvent = safeDivide(totalCost, TOTAL_EVENTS, 0);
      const annualPerMember = safeDivide(totalCost, members, 0);
      const costPerMemberEvent = safeDivide(costPerEvent, members, 0);

      // Update main results
      totalTicketsEl.textContent = totalTickets.toString();
      cardTicketsEl.textContent = totalCardTickets.toString();
      transactionFeesEl.textContent = formatCurrency(totalFees);
      totalCostEl.textContent = formatCurrency(totalCost);
      costPercentEl.textContent = formatPercentage(costPercent);
      costPerEventEl.textContent = formatCurrency(costPerEvent);
      annualPerMemberEl.textContent = formatCurrency(annualPerMember);
      costPerMemberEl.textContent = formatCurrency(costPerMemberEvent);

      // Calculate per-event breakdowns
      const cardSmallCount = safeRound(attSmall * (cardPct / 100), 0);
      const cardLargeCount = safeRound(attLarge * (cardPct / 100), 0);
      const feeSmall = safeRound(cardSmallCount * feePerCard, 2);
      const feeLarge = safeRound(cardLargeCount * feePerCard, 2);
      const subSplit = safeDivide(annualPremium, TOTAL_EVENTS, 0);

      // Update table
      attSmallCell.textContent = attSmall.toString();
      attLargeCell.textContent = attLarge.toString();
      cardSmall.textContent = cardSmallCount.toString();
      cardLarge.textContent = cardLargeCount.toString();
      revSmall.textContent = formatCurrency(cardSmallCount * ticketPrice);
      revLarge.textContent = formatCurrency(cardLargeCount * ticketPrice);
      feesSmall.textContent = formatCurrency(feeSmall);
      feesLarge.textContent = formatCurrency(feeLarge);
      totalSmall.textContent = formatCurrency(feeSmall + subSplit);
      totalLarge.textContent = formatCurrency(feeLarge + subSplit);

      const smallRevenue = attSmall * ticketPrice;
      const largeRevenue = attLarge * ticketPrice;
      
      pctSmall.textContent = formatPercentage(safeDivide((feeSmall + subSplit) * 100, smallRevenue, 0));
      pctLarge.textContent = formatPercentage(safeDivide((feeLarge + subSplit) * 100, largeRevenue, 0));
      
      perMemberSmall.textContent = formatCurrency(safeDivide(feeSmall + subSplit, members, 0));
      perMemberLarge.textContent = formatCurrency(safeDivide(feeLarge + subSplit, members, 0));

      // Update dynamic chart
      const memberData = [], costData = [];
      for (let m = 20; m <= 120; m += 5) {
        memberData.push(m);
        costData.push(safeRound(safeDivide(totalCost, m, 0), 2));
      }
      dynamicChart.data.labels = memberData;
      dynamicChart.data.datasets[0].data = costData;
      dynamicChart.update();
    }

    // Event listeners
    [attendanceSmallInput, attendanceLargeInput, ticketPriceInput, cardPercentInput, monthlyPremiumCostInput, memberCountInput]
      .forEach(el => el.addEventListener('input', recalc));

    // Initial calculation
    recalc();
  </script>
</body>
</html>
